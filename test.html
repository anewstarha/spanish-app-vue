<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>最终诊断测试</title>
</head>
<body>
    <h1>最终诊断测试：上传WAV文件</h1>
    <p>这个页面用来测试您的Supabase后端函数是否能正确处理一个已知的、完好的WAV文件。</p>

    <hr>

    <p><b>步骤 1:</b> 选择一个您确认可以正常工作的西班牙语WAV文件（比如您在Speech Studio测试成功过的那个）。</p>
    <input type="file" id="audioFileInput" accept="audio/wav">

    <p><b>步骤 2:</b> 点击按钮上传并进行识别。</p>
    <button id="uploadButton">上传并识别</button>

    <hr>

    <h2>识别结果:</h2>
    <pre id="resultOutput" style="background-color: #f0f0f0; padding: 1rem; border-radius: 5px; min-height: 50px;"></pre>

    <script>
        const uploadButton = document.getElementById('uploadButton');
        const audioFileInput = document.getElementById('audioFileInput');
        const resultOutput = document.getElementById('resultOutput');

        // 已将您的信息填入下方
        const SUPABASE_FUNCTION_URL = "https://rvarfascuwvponxwdeoe.supabase.co/functions/v1/transcribe-audio-node";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2YXJmYXNjdXd2cG9ueHdkZW9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNTE3MjYsImV4cCI6MjA3NDYyNzcyNn0.AXTL5HwbBPgkKcTwAbUerHyfCa0xUJnvIgb4o1xuPos";

        uploadButton.addEventListener('click', async () => {
            const file = audioFileInput.files[0];
            if (!file) {
                resultOutput.textContent = "请先选择一个WAV文件。";
                return;
            }

            resultOutput.textContent = "正在上传和识别，请稍候...";

            const formData = new FormData();
            formData.append('audio', file, file.name);

            try {
                // 注意：为了简单测试，这里直接使用 anon key。
                // 在您的正式应用中，使用用户的 session token 是更安全的做法。
                const response = await fetch(SUPABASE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: formData,
                });

                const responseData = await response.json();

                if (!response.ok) {
                    throw new Error(responseData.error || `请求失败，状态码: ${response.status}`);
                }

                resultOutput.textContent = JSON.stringify(responseData, null, 2);

            } catch (error) {
                resultOutput.textContent = `发生错误: ${error.message}`;
            }
        });
    </script>
</body>
</html>